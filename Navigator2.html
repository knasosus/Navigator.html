<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>–ù–∞–≤–∏–≥–∞—Ç–æ—Ä —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π –∑–æ–Ω</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
html,body{height:100%;margin:0;padding:0;}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
#container{display:flex;height:100%;}
#map{flex:3;min-height:400px;}
#sidebar{flex:1;background:#f5f5f5;padding:20px;border-left:1px solid #ddd;overflow-y:auto;}
.control-panel{background:white;padding:15px;border-radius:8px;margin-bottom:20px;box-shadow:0 2px 4px rgba(0,0,0,0.1);}
h2{margin-bottom:15px;color:#333;}
h3{margin:15px 0 10px 0;color:#555;}
button{background:#4CAF50;color:white;border:none;padding:10px 15px;border-radius:4px;cursor:pointer;margin:5px;transition:0.3s;}
button:hover{background:#45a049;}
button.secondary{background:#2196F3;}
button.secondary:hover{background:#0b7dda;}
button.danger{background:#f44336;}
button.danger:hover{background:#d32f2f;}
.blocked-zone{background:#ffebee;padding:10px;margin:10px 0;border-radius:4px;border-left:4px solid #f44336;display:flex;justify-content:space-between;align-items:center;}
input{width:100%;padding:8px;margin:5px 0 10px 0;border:1px solid #ddd;border-radius:4px;}
#status{padding:10px;border-radius:4px;margin-top:10px;display:none;}
</style>
</head>
<body>
<div id="container">
<div id="map"></div>
<div id="sidebar">
<div class="control-panel">
<h2>–ù–∞–≤–∏–≥–∞—Ç–æ—Ä —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π –∑–æ–Ω</h2>
<button id="locateBtn">üìç –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
<button id="addZoneBtn" class="secondary">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—Ä–µ—Ç–Ω—É—é –∑–æ–Ω—É</button>
<div id="status"></div>
</div>
<div class="control-panel">
<h3>–ó–∞–ø—Ä–µ—Ç–Ω—ã–µ –∑–æ–Ω—ã</h3>
<div id="zonesList"></div>
</div>
<div class="control-panel">
<h3>–ü–æ–∏—Å–∫ –º–∞—Ä—à—Ä—É—Ç–∞</h3>
<input type="text" id="startPoint" placeholder="–û—Ç–∫—É–¥–∞ (–∞–¥—Ä–µ—Å)">
<input type="text" id="endPoint" placeholder="–ö—É–¥–∞ (–∞–¥—Ä–µ—Å)">
<button id="routeBtn" class="secondary">üó∫Ô∏è –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
<button id="clearRouteBtn">–û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
</div>
</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([50.4501,30.5234],12); // –ö–∏–µ–≤
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);

let blockedZones=[];
let currentRoute=null;

// UI
const locateBtn=document.getElementById('locateBtn');
const addZoneBtn=document.getElementById('addZoneBtn');
const routeBtn=document.getElementById('routeBtn');
const clearRouteBtn=document.getElementById('clearRouteBtn');
const startInput=document.getElementById('startPoint');
const endInput=document.getElementById('endPoint');
const zonesList=document.getElementById('zonesList');
const status=document.getElementById('status');

function showStatus(msg,type='info'){
    status.textContent=msg;
    status.style.display='block';
    status.style.background=type==='success'?'#d4edda':type==='warning'?'#fff3cd':'#f8d7da';
    setTimeout(()=>status.style.display='none',3000);
}

// GEO
async function geocode(query){
    const url=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;
    const res=await fetch(url,{headers:{'User-Agent':'NavigatorApp'}});
    const data=await res.json();
    if(!data.length) throw new Error('–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');
    return {lat:+data[0].lat,lng:+data[0].lon};
}

async function getRoute(a,b){
    const url=`https://router.project-osrm.org/route/v1/driving/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;
    const res=await fetch(url);
    const data=await res.json();
    if(!data.routes.length) throw new Error('–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
    return data.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]);
}

// BLOCKED ZONES
function addBlockedZone(zone){
    blockedZones.push(zone);
    renderZoneOnMap(zone);
    updateZonesList();
}

function renderZoneOnMap(zone){
    let layer;
    if(zone.type==='circle'){
        layer=L.circle(zone.center,{radius:zone.radius,color:'red',fillColor:'#f03',fillOpacity:0.3}).addTo(map);
    }
    zone.layer=layer;
}

function updateZonesList(){
    zonesList.innerHTML='';
    blockedZones.forEach(zone=>{
        const div=document.createElement('div');
        div.className='blocked-zone';
        div.innerHTML=`<span>${zone.name} (${zone.type})</span><button class="danger">‚úï</button>`;
        div.querySelector('button').onclick=()=>{
            if(zone.layer) map.removeLayer(zone.layer);
            blockedZones=blockedZones.filter(z=>z!==zone);
            updateZonesList();
            showStatus('–ó–æ–Ω–∞ —É–¥–∞–ª–µ–Ω–∞','warning');
        };
        zonesList.appendChild(div);
    });
}

// ADD ZONE
addZoneBtn.addEventListener('click',()=>{
    const name=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –∑–æ–Ω—ã:','–ó–∞–ø—Ä–µ—Ç–Ω–∞—è –∑–æ–Ω–∞');
    if(!name) return;
    const radius=prompt('–†–∞–¥–∏—É—Å (–º):','500');
    if(!radius||isNaN(radius)) return;
    showStatus('–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∑–æ–Ω—ã','info');
    const clickHandler=e=>{
        addBlockedZone({id:Date.now(),name:name,center:e.latlng,radius:+radius,type:'circle'});
        map.off('click',clickHandler);
        showStatus(`–ó–æ–Ω–∞ "${name}" –¥–æ–±–∞–≤–ª–µ–Ω–∞`,'success');
    };
    map.on('click',clickHandler);
});

// LOCATE
locateBtn.addEventListener('click',()=>{
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(p=>{
            map.setView([p.coords.latitude,p.coords.longitude],15);
            L.marker([p.coords.latitude,p.coords.longitude]).addTo(map).bindPopup('–í—ã');
            showStatus('–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ','success');
        },()=>showStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å','error'));
    }
});

// ROUTE
function lineIntersectsCircle(line,center,radius){return line.some(p=>map.distance(p,center)<radius);}
function routeHitsBlockedZone(route){return blockedZones.find(z=>z.type==='circle' && lineIntersectsCircle(route,z.center,z.radius));}
function generateBypassPoint(zone){
    const angle=Math.random()*2*Math.PI;
    const offset=zone.radius+300;
    return {lat:zone.center.lat+(offset/111320)*Math.sin(angle), lng:zone.center.lng+(offset/111320)*Math.cos(angle)};
}

routeBtn.addEventListener('click',async()=>{
    try{
        const start=await geocode(startInput.value);
        const end=await geocode(endInput.value);
        let route=await getRoute(start,end);
        let zone=routeHitsBlockedZone(route);
        if(zone){
            showStatus(`–û–±—Ö–æ–¥ –∑–æ–Ω—ã: ${zone.name}`,'warning');
            const bypass=generateBypassPoint(zone);
            const r1=await getRoute(start,bypass);
            const r2=await getRoute(bypass,end);
            route=[...r1,...r2];
        }
        if(currentRoute) map.removeLayer(currentRoute);
        currentRoute=L.polyline(route,{color:'blue',weight:5}).addTo(map);
        map.fitBounds(currentRoute.getBounds());
        L.marker([start.lat,start.lng]).addTo(map).bindPopup('–ù–∞—á–∞–ª–æ');
        L.marker([end.lat,end.lng]).addTo(map).bindPopup('–ö–æ–Ω–µ—Ü');
        showStatus('–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω','success');
    }catch(e){console.error(e);showStatus('–û—à–∏–±–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞','error');}
});

clearRouteBtn.addEventListener('click',()=>{
    if(currentRoute) map.removeLayer(currentRoute);
    startInput.value=''; endInput.value='';
});
</script>
</body>
</html>
