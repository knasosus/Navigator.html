<!DOCTYPE html>  <html>  
<head>  
    <title>–ù–∞–≤–∏–≥–∞—Ç–æ—Ä —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π –∑–æ–Ω</title>  
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />  
    <style>  
        * {  
            margin: 0;  
            padding: 0;  
            box-sizing: border-box;  
        }  body {  
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;  
    }  
      
    #container {  
        display: flex;  
        height: 100vh;  
    }  
      
    #map {  
        flex: 3;  
    }  
      
    #sidebar {  
        flex: 1;  
        background: #f5f5f5;  
        padding: 20px;  
        border-left: 1px solid #ddd;  
        overflow-y: auto;  
    }  
      
    .control-panel {  
        background: white;  
        padding: 15px;  
        border-radius: 8px;  
        margin-bottom: 20px;  
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);  
    }  
      
    h2 {  
        margin-bottom: 15px;  
        color: #333;  
    }  
      
    h3 {  
        margin: 15px 0 10px 0;  
        color: #555;  
    }  
      
    button {  
        background: #4CAF50;  
        color: white;  
        border: none;  
        padding: 10px 15px;  
        border-radius: 4px;  
        cursor: pointer;  
        margin: 5px;  
        transition: background 0.3s;  
    }  
      
    button:hover {  
        background: #45a049;  
    }  
      
    button.secondary {  
        background: #2196F3;  
    }  
      
    button.secondary:hover {  
        background: #0b7dda;  
    }  
      
    button.danger {  
        background: #f44336;  
    }  
      
    button.danger:hover {  
        background: #d32f2f;  
    }  
      
    .blocked-zone {  
        background: #ffebee;  
        padding: 10px;  
        margin: 10px 0;  
        border-radius: 4px;  
        border-left: 4px solid #f44336;  
    }  
      
    input {  
        width: 100%;  
        padding: 8px;  
        margin: 5px 0 10px 0;  
        border: 1px solid #ddd;  
        border-radius: 4px;  
    }  
      
    .zone-info {  
        display: flex;  
        justify-content: space-between;  
        align-items: center;  
    }  
      
    .zone-name {  
        font-weight: bold;  
    }  
      
    .zone-radius {  
        color: #666;  
        font-size: 0.9em;  
    }  
      
    #status {  
        padding: 10px;  
        background: #e3f2fd;  
        border-radius: 4px;  
        margin-top: 10px;  
        display: none;  
    }  
</style>

</head>  
<body>  
    <div id="container">  
        <div id="map"></div>  
        <div id="sidebar">  
            <div class="control-panel">  
                <h2>–ù–∞–≤–∏–≥–∞—Ç–æ—Ä —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π –∑–æ–Ω</h2>  
                <button id="locateBtn">üìç –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>  
                <button id="addZoneBtn" class="secondary">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—Ä–µ—Ç–Ω—É—é –∑–æ–Ω—É</button>  <div id="status"></div>  
        </div>  
          
        <div class="control-panel">  
            <h3>–ó–∞–ø—Ä–µ—Ç–Ω—ã–µ –∑–æ–Ω—ã</h3>  
            <div id="zonesList">  
                <!-- –°–ø–∏—Å–æ–∫ –∑–æ–Ω –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->  
            </div>  
        </div>  
          
        <div class="control-panel">  
            <h3>–ü–æ–∏—Å–∫ –º–∞—Ä—à—Ä—É—Ç–∞</h3>  
            <input type="text" id="startPoint" placeholder="–û—Ç–∫—É–¥–∞ (–≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ)">  
            <input type="text" id="endPoint" placeholder="–ö—É–¥–∞ (–∞–¥—Ä–µ—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è)">  
            <button id="routeBtn" class="secondary">üó∫Ô∏è –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>  
            <button id="clearRouteBtn">–û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>  
        </div>  
          
        <div class="control-panel">  
            <h3>–†–µ–∂–∏–º —Ä–∏—Å–æ–≤–∞–Ω–∏—è –∑–æ–Ω</h3>  
            <p>–ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –∑–æ–Ω—É", –∑–∞—Ç–µ–º –∫–ª–∏–∫–∞–π—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–Ω–æ–≥–æ—É–≥–æ–ª—å–Ω–∏–∫–∞</p>  
            <button id="drawPolygonBtn" class="secondary">üéØ –ù–∞—Ä–∏—Å–æ–≤–∞—Ç—å –º–Ω–æ–≥–æ—É–≥–æ–ª—å–Ω–∏–∫</button>  
            <button id="cancelDrawingBtn" class="danger">–û—Ç–º–µ–Ω–∏—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ</button>  
        </div>  
    </div>  
</div>  

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>  
<script>  
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã  
    const map = L.map('map').setView([55.7558, 37.6173], 12); // –ú–æ—Å–∫–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é  
      
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {  
        attribution: '¬© OpenStreetMap contributors'  
    }).addTo(map);  
      
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è  
    let blockedZones = [];  
    let currentRoute = null;  
    let isDrawing = false;  
    let drawnItems = new L.FeatureGroup();  
    let currentPolygon = null;  
    map.addLayer(drawnItems);  
      
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–æ–Ω—ã –∏–∑ localStorage  
    loadZones();  
      
    // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞  
    const locateBtn = document.getElementById('locateBtn');  
    const addZoneBtn = document.getElementById('addZoneBtn');  
    const routeBtn = document.getElementById('routeBtn');  
    const clearRouteBtn = document.getElementById('clearRouteBtn');  
    const drawPolygonBtn = document.getElementById('drawPolygonBtn');  
    const cancelDrawingBtn = document.getElementById('cancelDrawingBtn');  
    const zonesList = document.getElementById('zonesList');  
    const status = document.getElementById('status');  
      
    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è  
    locateBtn.addEventListener('click', () => {  
        if (navigator.geolocation) {  
            navigator.geolocation.getCurrentPosition(  
                (position) => {  
                    const lat = position.coords.latitude;  
                    const lng = position.coords.longitude;  
                    map.setView([lat, lng], 15);  
                      
                    // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä  
                    L.marker([lat, lng])  
                        .addTo(map)  
                        .bindPopup('–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ')  
                        .openPopup();  
                      
                    showStatus('–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ', 'success');  
                },  
                (error) => {  
                    showStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ', 'error');  
                }  
            );  
        }  
    });  
      
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø—Ä–µ—Ç–Ω–æ–π –∑–æ–Ω—ã (–∫—Ä—É–≥)  
    addZoneBtn.addEventListener('click', () => {  
        const zoneName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–µ—Ç–Ω–æ–π –∑–æ–Ω—ã:', '–ó–∞–ø—Ä–µ—Ç–Ω–∞—è –∑–æ–Ω–∞');  
        if (!zoneName) return;  
          
        const radius = prompt('–í–≤–µ–¥–∏—Ç–µ —Ä–∞–¥–∏—É—Å –∑–æ–Ω—ã –≤ –º–µ—Ç—Ä–∞—Ö:', '500');  
        if (!radius || isNaN(radius)) return;  
          
        // –ü—Ä–æ—Å–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–ª–∏–∫–Ω—É—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ  
        showStatus('–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –∑–∞–ø—Ä–µ—Ç–Ω—É—é –∑–æ–Ω—É', 'info');  
          
        const clickHandler = (e) => {  
            const center = e.latlng;  
            const zone = {  
                id: Date.now(),  
                name: zoneName,  
                center: center,  
                radius: parseInt(radius),  
                type: 'circle'  
            };  
              
            addBlockedZone(zone);  
            map.off('click', clickHandler);  
            showStatus(`–ó–æ–Ω–∞ "${zoneName}" –¥–æ–±–∞–≤–ª–µ–Ω–∞`, 'success');  
        };  
          
        map.on('click', clickHandler);  
    });  
      
    // –†–µ–∂–∏–º —Ä–∏—Å–æ–≤–∞–Ω–∏—è –º–Ω–æ–≥–æ—É–≥–æ–ª—å–Ω–∏–∫–∞  
    let polygonPoints = [];  
      
    drawPolygonBtn.addEventListener('click', () => {  
        isDrawing = true;  
        polygonPoints = [];  
        showStatus('–ö–ª–∏–∫–∞–π—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–µ—Ä—à–∏–Ω –º–Ω–æ–≥–æ—É–≥–æ–ª—å–Ω–∏–∫–∞. –î–≤–∞–∂–¥—ã –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.', 'info');  
          
        const clickHandler = (e) => {  
            if (!isDrawing) return;  
              
            polygonPoints.push(e.latlng);  
              
            if (currentPolygon) {  
                map.removeLayer(currentPolygon);  
            }  
              
            if (polygonPoints.length > 1) {  
                currentPolygon = L.polygon(polygonPoints, {  
                    color: 'red',  
                    fillColor: '#f03',  
                    fillOpacity: 0.3  
                }).addTo(map);  
            }  
              
            // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã —Ç–æ—á–µ–∫  
            L.circleMarker(e.latlng, {  
                radius: 5,  
                color: 'red'  
            }).addTo(map);  
        };  
          
        const dblClickHandler = () => {  
            if (polygonPoints.length < 3) {  
                showStatus('–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–Ω–æ–≥–æ—É–≥–æ–ª—å–Ω–∏–∫–∞ –Ω—É–∂–Ω–æ –∫–∞–∫ –º–∏–Ω–∏–º—É–º 3 —Ç–æ—á–∫–∏', 'error');  
                return;  
            }  
              
            const zoneName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–µ—Ç–Ω–æ–π –∑–æ–Ω—ã:', '–ó–∞–ø—Ä–µ—Ç–Ω–∞—è –∑–æ–Ω–∞');  
            if (!zoneName) return;  
              
            const zone = {  
                id: Date.now(),  
                name: zoneName,  
                points: [...polygonPoints],  
                type: 'polygon'  
            };  
              
            addBlockedZone(zone);  
            isDrawing = false;  
            polygonPoints = [];  
            if (currentPolygon) {  
                map.removeLayer(currentPolygon);  
                currentPolygon = null;  
            }  
              
            map.off('click', clickHandler);  
            map.off('dblclick', dblClickHandler);  
            showStatus(`–ó–æ–Ω–∞ "${zoneName}" –¥–æ–±–∞–≤–ª–µ–Ω–∞`, 'success');  
        };  
          
        map.on('click', clickHandler);  
        map.on('dblclick', dblClickHandler);  
    });  
      
    cancelDrawingBtn.addEventListener('click', () => {  
        isDrawing = false;  
        polygonPoints = [];  
        if (currentPolygon) {  
            map.removeLayer(currentPolygon);  
            currentPolygon = null;  
        }  
        showStatus('–†–∏—Å–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ', 'warning');  
    });  
      
    // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø—Ä–µ—Ç–Ω–æ–π –∑–æ–Ω—ã  
    function addBlockedZone(zone) {  
        blockedZones.push(zone);  
        saveZones();  
        renderZoneOnMap(zone);  
        updateZonesList();  
    }  
      
    // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∑–æ–Ω—ã –Ω–∞ –∫–∞—Ä—Ç–µ  
    function renderZoneOnMap(zone) {  
        let layer;  
          
        if (zone.type === 'circle') {  
            layer = L.circle(zone.center, {  
                radius: zone.radius,  
                color: 'red',  
                fillColor: '#f03',  
                fillOpacity: 0.3  
            }).addTo(map);  
        } else if (zone.type === 'polygon') {  
            layer = L.polygon(zone.points, {  
                color: 'red',  
                fillColor: '#f03',  
                fillOpacity: 0.3  
            }).addTo(map);  
        }  
          
        layer.bindPopup(`  
            <strong>${zone.name}</strong><br>  
            ${zone.type === 'circle' ? `–†–∞–¥–∏—É—Å: ${zone.radius}–º` : '–ú–Ω–æ–≥–æ—É–≥–æ–ª—å–Ω–∞—è –∑–æ–Ω–∞'}<br>  
            <button onclick="removeZone(${zone.id})">–£–¥–∞–ª–∏—Ç—å</button>  
        `);  
          
        zone.layer = layer;  
    }  
      
    // –£–¥–∞–ª–µ–Ω–∏–µ –∑–æ–Ω—ã (–≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–∑ –ø–æ–ø–∞–ø–∞)  
    window.removeZone = function(id) {  
        const index = blockedZones.findIndex(zone => zone.id === id);  
        if (index !== -1) {  
            map.removeLayer(blockedZones[index].layer);  
            blockedZones.splice(index, 1);  
            saveZones();  
            updateZonesList();  
            showStatus('–ó–æ–Ω–∞ —É–¥–∞–ª–µ–Ω–∞', 'warning');  
        }  
    };  
      
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–æ–Ω –≤ —Å–∞–π–¥–±–∞—Ä–µ  
    function updateZonesList() {  
        zonesList.innerHTML = '';  
          
        blockedZones.forEach(zone => {  
            const zoneDiv = document.createElement('div');  
            zoneDiv.className = 'blocked-zone';  
            zoneDiv.innerHTML = `  
                <div class="zone-info">  
                    <div>  
                        <div class="zone-name">${zone.name}</div>  
                        <div class="zone-radius">  
                            ${zone.type === 'circle' ? `–ö—Ä—É–≥, —Ä–∞–¥–∏—É—Å: ${zone.radius}–º` : '–ú–Ω–æ–≥–æ—É–≥–æ–ª—å–Ω–∏–∫'}  
                        </div>  
                    </div>  
                    <button class="danger" onclick="removeZone(${zone.id})">‚úï</button>  
                </div>  
            `;  
            zonesList.appendChild(zoneDiv);  
        });  
    }  
      
    // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ–µ, –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ API)  
    routeBtn.addEventListener('click', async () => {  
const startText = startPoint.value;  
const endText = endPoint.value;  

if (!startText || !endText) {  
    showStatus('–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å–∞', 'error');  
    return;  
}  

try {  
    const start = await geocode(startText);  
    const end = await geocode(endText);  

    const route1 = await getRoute(start, end);  

    const hitZone = routeHitsBlockedZone(route1);  

    let finalRoute = route1;  

    if (hitZone) {  
        showStatus(`–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∑–æ–Ω–∞ "${hitZone.name}", —Å—Ç—Ä–æ–∏–º –æ–±—Ö–æ–¥`, 'warning');  

        const bypass = generateBypassPoint(hitZone, start, end);  

        const part1 = await getRoute(start, bypass);  
        const part2 = await getRoute(bypass, end);  

        finalRoute = [...part1, ...part2];  
    }  

    if (currentRoute) map.removeLayer(currentRoute);  

    currentRoute = L.polyline(finalRoute, {  
        color: 'blue',  
        weight: 5  
    }).addTo(map);  

    map.fitBounds(currentRoute.getBounds());  

    L.marker([start.lat, start.lng]).addTo(map).bindPopup('–ù–∞—á–∞–ª–æ');  
    L.marker([end.lat, end.lng]).addTo(map).bindPopup('–ö–æ–Ω–µ—Ü');  

    showStatus('–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω —Å –æ–±—Ö–æ–¥–æ–º –∑–æ–Ω', 'success');  

} catch (e) {  
    console.error(e);  
    showStatus('–û—à–∏–±–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞', 'error');  
}

});

// –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–∞—Ä—à—Ä—É—Ç  
        if (currentRoute) {  
            map.removeLayer(currentRoute);  
        }  
          
        routeBtn.addEventListener('click', async () => {  
const startText = document.getElementById('startPoint').value;  
const endText = document.getElementById('endPoint').value;  

if (!startText || !endText) {  
    showStatus('–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞', 'error');  
    return;  
}  

try {  
    // 1. –ì–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ (–∞–¥—Ä–µ—Å ‚Üí –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã)  
    const start = await geocode(startText);  
    const end = await geocode(endText);  

    if (currentRoute) {  
        map.removeLayer(currentRoute);  
    }  

    // 2. –ó–∞–ø—Ä–æ—Å –º–∞—Ä—à—Ä—É—Ç–∞ OSRM  
    const url = `https://router.project-osrm.org/route/v1/driving/` +  
        `${start.lng},${start.lat};${end.lng},${end.lat}` +  
        `?overview=full&geometries=geojson`;  

    const res = await fetch(url);  
    const data = await res.json();  

    if (!data.routes || !data.routes.length) {  
        showStatus('–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');  
        return;  
    }  

    const routeCoords = data.routes[0].geometry.coordinates.map(  
        c => [c[1], c[0]]  
    );  

    // 3. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞  
    currentRoute = L.polyline(routeCoords, {  
        color: 'blue',  
        weight: 5  
    }).addTo(map);  

    L.marker([start.lat, start.lng]).addTo(map).bindPopup('–ù–∞—á–∞–ª–æ');  
    L.marker([end.lat, end.lng]).addTo(map).bindPopup('–ö–æ–Ω–µ—Ü');  

    map.fitBounds(currentRoute.getBounds());  

    showStatus('–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω', 'success');  

} catch (e) {  
    showStatus('–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞', 'error');  
    console.error(e);  
}

});

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—Ö–æ–¥–∏—Ç –ª–∏ –º–∞—Ä—à—Ä—É—Ç —á–µ—Ä–µ–∑ –∑–∞–ø—Ä–µ—Ç–Ω—ã–µ –∑–æ–Ω—ã  
        const routeLine = [startPoint, endPoint];  
        let passesThroughBlockedZone = false;  
          
        // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è  
        blockedZones.forEach(zone => {  
            if (zone.type === 'circle') {  
                // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è  
                const dist = map.distance(startPoint, zone.center);  
                if (dist < zone.radius) {  
                    passesThroughBlockedZone = true;  
                }  
            }  
        });  
          
        // –†–∏—Å—É–µ–º –º–∞—Ä—à—Ä—É—Ç  
        currentRoute = L.polyline(routeLine, {  
            color: passesThroughBlockedZone ? 'orange' : 'blue',  
            weight: 4,  
            opacity: 0.7  
        }).addTo(map);  
          
        if (passesThroughBlockedZone) {  
            showStatus('‚ö†Ô∏è –ú–∞—Ä—à—Ä—É—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –∑–∞–ø—Ä–µ—Ç–Ω—É—é –∑–æ–Ω—É!', 'warning');  
        } else {  
            showStatus('–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω (–±–µ–∑–æ–ø–∞—Å–Ω—ã–π)', 'success');  
        }  
          
        // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã  
        L.marker(startPoint).addTo(map).bindPopup('–ù–∞—á–∞–ª–æ');  
        L.marker(endPoint).addTo(map).bindPopup('–ö–æ–Ω–µ—Ü');  
          
        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–µ  
        const bounds = L.latLngBounds([startPoint, endPoint]);  
        map.fitBounds(bounds);  
    });  
      
    clearRouteBtn.addEventListener('click', () => {  
        if (currentRoute) {  
            map.removeLayer(currentRoute);  
            currentRoute = null;  
        }  
        document.getElementById('startPoint').value = '';  
        document.getElementById('endPoint').value = '';  
        showStatus('–ú–∞—Ä—à—Ä—É—Ç –æ—á–∏—â–µ–Ω', 'info');  
    });  
      
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ localStorage  
    function saveZones() {  
        const zonesToSave = blockedZones.map(zone => ({  
            ...zone,  
            layer: undefined // –£–±–∏—Ä–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Å–ª–æ–π –∫–∞—Ä—Ç—ã  
        }));  
        localStorage.setItem('blockedZones', JSON.stringify(zonesToSave));  
    }  
      
    function loadZones() {  
        const savedZones = localStorage.getItem('blockedZones');  
        if (savedZones) {  
            blockedZones = JSON.parse(savedZones);  
            blockedZones.forEach(zone => {  
                renderZoneOnMap(zone);  
                async function geocode(query) {  
const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;  
const res = await fetch(url, {  
    headers: { 'User-Agent': 'NavigatorApp' }  
});  
const data = await res.json();  

if (!data.length) {  
    throw new Error('–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');  
}  

return {  
    lat: parseFloat(data[0].lat),  
    lng: parseFloat(data[0].lon)  
};  
                }  
            });  
            updateZonesList();  
        }  
    }  
      
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç—É—Å–∞  
    function showStatus(message, type) {  
        status.textContent = message;  
        status.style.display = 'block';  
        status.style.background =   
            type === 'success' ? '#d4edda' :  
            type === 'error' ? '#f8d7da' :  
            type === 'warning' ? '#fff3cd' :  
            '#d1ecf1';  
        status.style.color =   
            type === 'success' ? '#155724' :  
            type === 'error' ? '#721c24' :  
            type === 'warning' ? '#856404' :  
            '#0c5460';  
          
        setTimeout(() => {  
            status.style.display = 'none';  
        }, 3000);  
    }  
      
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è  
    updateZonesList();  
    showStatus('–ù–∞–≤–∏–≥–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω. –î–æ–±–∞–≤—å—Ç–µ –∑–∞–ø—Ä–µ—Ç–Ω—ã–µ –∑–æ–Ω—ã –∏–ª–∏ –ø–æ—Å—Ç—Ä–æ–π—Ç–µ –º–∞—Ä—à—Ä—É—Ç.', 'info');  
    function lineIntersectsCircle(line, center, radius) {  
for (let i = 0; i < line.length; i++) {  
    const d = map.distance(line[i], center);  
    if (d < radius) return true;  
}  
return false;

}

function routeHitsBlockedZone(routeCoords) {
for (const zone of blockedZones) {
if (zone.type === 'circle') {
if (lineIntersectsCircle(routeCoords, zone.center, zone.radius)) {
return zone;
}
}
}
return null;
}
function generateBypassPoint(zone, start, end) {
const angle = Math.atan2(
end.lat - zone.center.lat,
end.lng - zone.center.lng
);

const offset = zone.radius + 300; // 300 –º –∑–∞–ø–∞—Å  

const latOffset = (offset / 111320) * Math.sin(angle + Math.PI / 2);  
const lngOffset = (offset / 111320) * Math.cos(angle + Math.PI / 2);  

return {  
    lat: zone.center.lat + latOffset,  
    lng: zone.center.lng + lngOffset  
};  
    }  
</script>

</body>  
</html>
