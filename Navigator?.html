<script>
/* ================== КАРТА ================== */
const map = L.map('map').setView([55.7558, 37.6173], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
}).addTo(map);

let blockedZones = [];
let currentRoute = null;

/* ================== UI ================== */
const routeBtn = document.getElementById('routeBtn');
const clearRouteBtn = document.getElementById('clearRouteBtn');
const startInput = document.getElementById('startPoint');
const endInput = document.getElementById('endPoint');
const status = document.getElementById('status');

/* ================== GEO ================== */
async function geocode(query) {
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;
    const res = await fetch(url, { headers: { 'User-Agent': 'NavigatorApp' }});
    const data = await res.json();
    if (!data.length) throw new Error('Адрес не найден');
    return { lat: +data[0].lat, lng: +data[0].lon };
}

async function getRoute(a, b) {
    const url = `https://router.project-osrm.org/route/v1/driving/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;
    const res = await fetch(url);
    const data = await res.json();
    if (!data.routes.length) throw new Error('Маршрут не найден');
    return data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
}

/* ================== ОБХОД ЗОН ================== */
function lineIntersectsCircle(line, center, radius) {
    return line.some(p => map.distance(p, center) < radius);
}

function routeHitsBlockedZone(route) {
    return blockedZones.find(z =>
        z.type === 'circle' && lineIntersectsCircle(route, z.center, z.radius)
    );
}

function generateBypassPoint(zone) {
    const angle = Math.random() * Math.PI * 2;
    const offset = zone.radius + 400;
    return {
        lat: zone.center.lat + (offset / 111320) * Math.sin(angle),
        lng: zone.center.lng + (offset / 111320) * Math.cos(angle)
    };
}

/* ================== МАРШРУТ ================== */
routeBtn.addEventListener('click', async () => {
    try {
        const start = await geocode(startInput.value);
        const end = await geocode(endInput.value);

        let route = await getRoute(start, end);
        const zone = routeHitsBlockedZone(route);

        if (zone) {
            showStatus(`Обход зоны: ${zone.name}`, 'warning');
            const bypass = generateBypassPoint(zone);
            const r1 = await getRoute(start, bypass);
            const r2 = await getRoute(bypass, end);
            route = [...r1, ...r2];
        }

        if (currentRoute) map.removeLayer(currentRoute);
        currentRoute = L.polyline(route, { color: 'blue', weight: 5 }).addTo(map);
        map.fitBounds(currentRoute.getBounds());

        showStatus('Маршрут построен', 'success');
    } catch (e) {
        console.error(e);
        showStatus('Ошибка маршрута', 'error');
    }
});

/* ================== ОЧИСТКА ================== */
clearRouteBtn.addEventListener('click', () => {
    if (currentRoute) map.removeLayer(currentRoute);
    startInput.value = '';
    endInput.value = '';
});

/* ================== STATUS ================== */
function showStatus(msg, type) {
    status.textContent = msg;
    status.style.display = 'block';
    status.style.background =
        type === 'success' ? '#d4edda' :
        type === 'warning' ? '#fff3cd' :
        '#f8d7da';
    setTimeout(() => status.style.display = 'none', 3000);
}
</script>
